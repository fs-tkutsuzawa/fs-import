# コアロジック現状分析レポート

**目的**: プロジェクトの初期構想（`@docs/context.md`）と、現在のコアロジック（`@server/src`）およびテストスイート（`@server/src/tests`）の実装状況を比較・分析する。これにより、完了済みの機能と、今後のUI/API連携の計画策定に必要となる課題を明確化する。

---

### 1. `@docs/context.md`の構想サマリー

当初の構想では、財務モデリングエンジンは以下の主要な概念で構成されることが示されていた。

- **FAM (FY-Account Matrix) モデル**: 勘定科目と会計期間を軸とする、計算と結果保持のための中核的なデータ構造。
- **予測ロジック (Parameters型)**: `GROWTH_RATE`や`CALCULATION`といったルールに基づき、勘定科目の将来値を予測する仕組み。
- **AST (Abstract Syntax Tree)**: 上記の予測ロジックの依存関係を解決し、正しい順序で計算を実行するための計算グラフ。
- **B&C (Balance & Change)**: PL科目や固定値の変動を、BS科目に反映させるための仕組み。
- **現金連動**: PLの利益がBSの現金残高に影響を与える、三表連動の基本的な仕組み。

### 2. 現状の実装と各コンポーネントの役割

現在の`@server/src`配下のコードは、上記の構想を具現化し、さらに発展させたものとなっている。

- **`fam/fam.ts` (`FAM`クラス)**
  - **役割**: まさに構想にあった**FAMモデル**そのもの。財務モデル全体の状態（実績データ、ルール、計算結果）を保持し、計算プロセス全体を統括するオーケストレーター。
  - **機能**: 実績データのインポート、ルールの設定、複数年度にわたる計算の実行、そして最終的なテーブル形式でのデータ提供まで、エンジンとの対話における全ての窓口（Facade）を担う。

- **`engine/ast.ts` (ASTエンジン)**
  - **役割**: 構想にあった**ASTと予測ロジック**の実行部隊。
  - **機能**: `RuleInput`（`Parameters`型ルール）を解釈し、計算グラフを構築(`compileUnifiedAST`)、依存関係を解決しながら効率的に値を評価(`evalTopo`)する。このエンジンは会計コンテキストから独立しており、純粋な数式評価に特化している。

- **`model/*.ts` (データモデル群)**
  - **役割**: システム全体の「語彙」を定義する。
  - **機能**: `types.ts`は`Account`や`RuleInput`といった基本型を、`bc.ts`は`CFI`（B&Cルール）を、`globalAccount.ja.ts`は`GAID`（標準勘定科目）を定義する。これらの厳密な型定義が、エンジン全体の堅牢性を支えている。

### 3. 実装済み機能（完了済みのもの）

`@server/src/tests`配下のテストスイートは、以下の機能が当初の構想通り、あるいはそれ以上に高度化された形で実装済みであることを証明している。

- **PL予測モデルの完成**:
  - `plOnlyAst.test.ts`や`fam.behavior.test.ts`が証明するように、`Parameters`型ルール（前期比成長、他科目参照計算など）に基づくPL科目の予測計算は完全に機能している。

- **B&C（貸借調整）メカニズムの確立**:
  - `balanceAndChange.test.ts`が証明するように、減価償却や設備投資といったPL非経由の取引を、関連するBS科目に正しく反映させる`Balance & Change`の基本機能は確立されている。

- **【最重要】会計原則に忠実な三表連動モデルへの進化**:
  - 当初の構想にあった単純な「現金連動」から大きく進化し、**キャッシュフロー計算書（CF）を介して三表を連動させる、会計原則に忠実なコアロジックが完成している。**
  - これは、`cff.test.ts`（財務CF）、`cfi.test.ts`（投資CF）、`cfo.test.ts`（営業CF）という個別のCFコンポーネントのテストと、それらを統合した`bs_sections.test.ts`内の最終貸借一致テスト`[BS-G-02]`によって、その正しさが網羅的に証明されている。
  - これにより、`attachCash`という旧来の単純ロジックは完全に不要となり、より現実的で複雑な会計シナリオのモデル化が可能になった。

### 4. 今後の課題と対応（UI/API連携に向けて）

コア計算エンジンは極めて高機能かつ堅牢な状態にあるが、これをアプリケーションとして機能させるための「繋ぎこみ」の部分が未実装である。今後の計画策定においては、以下の課題に焦点を当てる必要がある。

- **課題1：API層の不在**
  - **現状**: `FAM`クラスという強力なエンジンは存在するが、UIからのリクエストを受け付けてこのエンジンを呼び出し、結果を返すためのAPIエンドポイントが存在しない。
  - **対応**: `interface_specification_report.md`で提案済みの`POST /api/models/:modelId/calculate`のような、計算実行のトリガーとなるAPIエンドポイントを`server/src/index.ts`に実装する必要がある。

- **課題2：データ変換ロジック（DB → エンジン）**
  - **現状**: `FAM`エンジンは、`importActuals`や`setRules`を通じて、特定の形式（`Account[]`, `RuleInput[]`など）のデータを入力として期待する。しかし、DBに永続化されているデータはテーブル形式であり、そのままではエンジンに渡せない。
  - **対応**: API層の責務として、DBから取得した`user_accounts`や`calculation_rules`のレコードを、`FAM`が要求する入力形式に変換するロジックを実装する必要がある。これは、`interface_specification_report.md`の「4. DBからFAM入力へのデータ変換仕様」で具体的に定義されている。

- **課題3：データ変換ロジック（エンジン → UI）**
  - **現状**: `FAM`エンジンの主要な出力（`getTable()`）は、計算に最適化されたマトリクス形式（`{ rows, columns, data }`）である。これはUIのデータグリッドが期待するフラットなJSON形式とは異なる。
  - **対応**: API層の責務として、エンジンから受け取ったマトリクス形式のデータを、UIが最も扱いやすい「1セル=1オブジェクト」のフラットな配列形式に「アンピボット」し、`interface_schema_improvement_proposal.md`で定義されたリッチなJSONスキーマに整形して返却するロジックを実装する必要がある。

### 5. 結論

`@docs/context.md`で描かれた当初の構想は、`@server/src`において**完全に達成されている**。それだけでなく、三表連動の核心部分は、会計原則にさらに忠実なキャッシュフローベースのロジックへと大きく進化を遂げた。

現状は「**非常に強力なエンジンは完成したが、まだ車体（API）と接続されていない**」状態と言える。

今後の開発計画は、このエンジンを外部から利用可能にするための**API層の構築**に集中すべきである。具体的には、**「DBからエンジンへの入力変換」**と**「エンジンからUIへの出力変換」**という2つのデータ変換ロジックの実装が、最優先のクリティカルパスとなる。
