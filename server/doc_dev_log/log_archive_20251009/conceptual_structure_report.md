# レポート：財務三表連動モデルの概念構造とロジック

**日付**: 2025年10月8日
**作成者**: Gemini
**目的**: 本財務モデリングエンジンの根幹をなす会計理論、データ構造、および計算ロジックを整理・文書化し、将来の保守・拡張を担当するすべてのエンジニアに対する共通理解を形成する。

---

## 1. はじめに：我々がモデル化しているもの

このシステムは、単なる数値計算機ではない。これは、**企業の経済活動が、最終的に「財務三表」という形式言語にどのように変換されるか**をシミュレートする、一種の解釈エンジン（Interpreter）である。

その核心は、会計学の最も美しい原則の一つである「**発生主義**」と「**現金主義**」の架け橋、すなわち**キャッシュフロー計算書（CF）**にある。PL（損益計算書）が発生主義の成果物、BS（貸借対照表）が特定時点の財産状況のスナップショットであるのに対し、CFはそれらの「差分（デルタ）」から、企業活動のダイナミズムそのものである現金の動きを炙り出す。

このエンジンは、この会計的真実をコードで再現することを唯一の目的とする。

## 2. システムの概念的理論構造

本エンジンは、以下の3つの階層的な概念で構成されている。

1.  **ルール層 (The Rule Layer)**: 個別の勘定科目が、将来どのように変動するかを定義する層。「売上は前期比5%成長する」「原価は売上の60%」といった、ビジネスの"物理法則"を記述する。
    - **実装**: `RuleInput`インターフェースと、それを解釈するAST（抽象構文木）エンジン。

2.  **取引層 (The Transaction Layer)**: 個別の予測ルールだけでは表現できない、PLを介さないBS勘定間の直接的な価値の移転を定義する層。「現金を対価に固定資産を購入する」「借入金を返済する」といった、具体的な経済イベントを記述する。
    - **実装**: B&C（Balance & Change）ルール (`CFI`インターフェース）。

3.  **連動層 (The Linkage Layer)**: 上記2つの層で計算された結果を統合し、会計原則に従って三表を最終的に連動させる層。ここの計算順序とロジックが、システムの健全性を決定する。
    - **実装**: `FAM.compute()`メソッド内のオーケストレーションロジック。

## 3. コアロジック：`compute`メソッドの"聖なる"実行順序

`compute`メソッドは、会計原則をコードに翻訳した、このシステムの"憲法"である。その処理順序は、以下の通り、厳密な意味を持つ。

1.  **PL計算 (Rule-based P&L Calculation)**
    - **処理**: `evalTopo`が、ルール層で定義されたPL関連の予測ルール（売上、費用など）を計算し、当期のPLを作成する。
    - **会計的意味**: まず、その期の事業活動によってどれだけの「利益」が（発生主義ベースで）生み出されたかを確定させる。

2.  **非現金BS計算 (Rule-based Non-Cash BS Calculation)**
    - **処理**: `evalTopo`が、ルール層で定義されたBS関連の予測ルール（例：「買掛金は原価のX%」）を計算する。
    - **会計的意味**: PLの活動に直接連動するBS項目（主に運転資本）の期末残高を確定させる。

3.  **BS繰越処理 (BS Roll-Forward)**
    - **処理**: `rollForwardBsAccounts`が、ルールが定義されていないBS勘定（資本金など）の残高を前期から繰り越す。**特に重要なのは、この段階でPLの純利益が利益剰余金に加算されること**である。
    - **会計的意味**: 「利益は株主のものであり、内部留保として純資産を増加させる」という、PLとBSを繋ぐ第一の架け橋を架ける。

4.  **取引適用 (B&C Application)**
    - **処理**: `applyBalanceChangeForFY`が、取引層で定義されたB&Cルール（設備投資、借入など）を適用し、関連するBS勘定（現金以外）の残高を更新する。
    - **会計的意味**: 個別の経営判断（投資、財務活動）をBSに反映させる。この時点ではまだ現金は動いていない。

5.  **CF計算と現金確定 (Cash Flow Calculation & Cash Determination)**
    - **処理**: `calculateAndStoreCashFlow`が、これまでの全計算結果を統合し、最終的な現金を確定させる。
      1.  **CFO計算**: `calculateCFO`が、純利益を起点に、非資金性損益（減価償却費、固定資産売却益など）と運転資本（売掛金、買掛金など）の増減を調整し、営業CFを算出する。
      2.  **CFI/CFF計算**: `applyBalanceChangeForFY`が返した現金影響の内訳（`{ cfi, cff }`）を取得する。
      3.  **現金残高の確定**: `期首現金 + CFO + CFI + CFF` の公式に基づき、期末の現金残高を計算し、BSテーブルに書き込む。
    - **会計的意味**: これこそがシステムの核心である。PL（発生主義）とBSの差分（デルタ）からCF（現金主義）を導き、その結果としてBSの最後のピースである「現金」を確定させる。このプロセスを経ることで、**BSの貸借は数学的必然として一致する**。

## 4. なぜこの構造が重要なのか

- **拡張性**: 新しい会計ルールや取引を追加したい場合、我々はこの構造のどこに手を入れるべきかを明確に判断できる。例えば、新しい非資金性費用は`calculateCFO`に、新しい種類の投資はB&Cルールと`applyBalanceChangeForFY`のCFI分類に追加すればよい。

- **デバッグの容易性**: 貸借が一致しない場合、問題はこの聖なる順序のどこにあるかを追跡できる。「CFOの計算がおかしいのか？」「B&Cの現金影響が二重計上されているのか？」といった仮説検証が、構造化されているため容易になる。

- **概念的整合性**: このアーキテクチャは、会計の専門家がExcelでモデルを組む際の思考フローと極めて類似している。これにより、エンジニアと会計ドメインの専門家との間のコミュニケーションコストを劇的に削減できる。

## 5. 結論

本エンジンは、単なるコードの集合体ではなく、会計という500年の歴史を持つ複式簿記の論理体系をソフトウェアとして表現しようとする試みである。その構造とロジックの背後にある「なぜ」を理解することは、10年後のエンジニアがこのシステムを保守し、さらに進化させていく上で、不可欠な羅針盤となるだろう。
