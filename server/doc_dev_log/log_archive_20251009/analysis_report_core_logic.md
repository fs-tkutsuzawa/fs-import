# コアロジック分析レポート

- Written by : Cemini CLI
- Date : 2025-10-05

## 1. プロジェクトの目的

`docs/context.md`および既存のソースコードから、このプロジェクトのコアロジックが目指すものを以下のように分析しました。

- **財務モデルの自動生成**: 実績のBS(貸借対照表)とPL(損益計算書)をインプットとし、ユーザーが定義した計算ルールに基づいて、将来の計画BS・PLを自動で算出する。
- **CF(キャッシュフロー計算書)の自動生成**: 生成されたBS・PLの変動から、キャッシュフロー計算書を自動で導出する。
- **柔軟な計算ルール**: 勘定科目ごとに、多様な計算ロジック（前期比成長率、特定科目への連動、固定値など）をユーザーが定義できる動的な計算エンジンを構築する。

## 2. コアロジックのアーキテクチャ

現在のコアロジックは、主に3つのコンポーネントで構成されています。

- **`FAM (Financial-Account Matrix)クラス` (`fam/fam.ts`)**:
  - 財務モデル全体の状態を管理する最上位クラス。
  - 実績データの取り込み、計算ルールの設定、複数年度にわたる計算実行のオーケストレーションを担当します。
  - 内部に勘定科目(`Account`)や年度(`Period`)ごとの計算結果を保持するテーブル(Grid)を持っています。
  - PL計算後の現金勘定の連動（`attachCash`）や、後述のB&Cロジックの適用など、会計原則に基づいた特殊な調整もこの層が担います。

- **`AST (Abstract Syntax Tree)エンジン` (`engine/ast.ts`)**:
  - 個別の勘定科目の計算ロジックを実行する心臓部。
  - 計算ルール(`RuleInput`)を「計算グラフ」としてASTに変換します。ノードは値を持つ終端(FF)と、2つの子ノードへの演算(TT)で構成されます。
  - `compileUnifiedAST`でルールセットからASTを構築し、`evalTopo`で依存関係を解決しながら（トポロジカルソート）、効率的に値を評価（計算）します。
  - このエンジン自体は、会計年度の概念から独立しており、純粋な数式評価に特化しています。

- **`データモデル` (`model/*.ts`)**:
  - `types.ts`: `Account` (勘定科目), `Period` (期間), `RuleInput` (計算ルール)など、システム全体で使われる基本的な型を定義しています。
  - `globalAccount.ja.ts`: `GAID`として標準的な勘定科目マスタを定義しています。これにより、ユーザーが定義した勘定科目をシステム共通の科目にマッピングできます。
  - `bc.ts`: `Balance & Change`ロジック（後述）のための型`CFI`を定義しています。

## 3. 現状の実装済み項目

ソースコードとテストコード(`server/src/tests/`)から、以下の機能が実装済みであると判断できます。

- **PL(損益計算書)の予測計算**:
  - `plOnlyAst.test.ts`や`fam.behavior.test.ts`から、PL科目の予測値計算がコア機能として実装されていることがわかります。
  - 実績値(`Actuals`)と計算ルール(`Rules`)を`FAM`にセットし、`compute`メソッドを呼び出すことで、複数年度のPLが計算されます。

- **多様な計算ルール(Parameters)**:
  - `RuleInput`型で定義された計算ロジック（`GROWTH_RATE`, `PERCENTAGE`, `CALCULATION`など）がASTエンジンによって解釈・実行されます。

- **現金勘定の連動**:
  - `fam.ts`の`attachCash`メソッドにより、PLの計算結果（基点利益）を前期の現金残高に加算して、当期の現金残高を計算するロジックが実装されています。

- **Balance & Change (B&C) の基本機能**:
  - `balanceAndChange.test.ts`から、特定のBS科目の残高を、PL科目や固定値（フロー科目）に基づいて増減させる「B&Cロジック」の雛形が実装されていることが確認できます。
  - 例えば、「減価償却費(PL)만큼固定資産(BS)を減らし、相手勘定は利益剰余金(BS)とする」といった処理がテストされています。

## 4. 未実装項目と課題

ユーザーの要望である「BSを含めた財務モデルの完成」に向けて、以下の項目が未実装または課題として残っています。

- **BS(貸借対照表)全体の計算ロジックの欠如**:
  - 現状、`FAM`クラスは`fs: 'PL'`とハードコードされており、PL計算に特化しています。BSとPLを同時に扱う仕組みが存在しません。
  - BS科目は、PL科目と異なり「期末残高 = 期首残高 + 当期変動」というストック計算が基本となります。このロジックを汎用的に実装する必要があります。

- **BSとPLの連携**:
  - PLで計算された「当期純利益」が、BSの「利益剰余金」に加算される、という最も基本的な連携が未実装です。

- **B&Cロジックの本格実装**:
  - 現在のB&CはPoC（概念実証）段階です。`context.md`にあるように、設備投資による固定資産の増加と現金の減少、借入による負債と現金の増加など、より複雑な仕訳パターンに対応する必要があります。
  - これには、PLだけでなく、PP&E（固定資産管理表）やFinancing（資金調達表）といったBS/PL以外のFAM（財務マトリクス）を参照する仕組みが必要です。

- **CF(キャッシュフロー計算書)の生成**:
  - 最終目標であるCFの自動生成ロジックは完全に未実装です。これを実現するには、計算済みのBS（前期・当期）の差分から各CF項目（営業CF・投資CF・財務CF）を計算する機能が必要になります。

## 5. 今後の開発仕様案

BS機能の実装と財務モデルの完成に向けて、以下のステップで開発を進めることを提案します。

- **Step 1: FAMクラスの拡張**
  - `FAM`クラスがPLだけでなく、BSも同時に管理できるように改修します。`private fs: 'PL'`の制約を外し、複数の財務諸表（`fs_type`）を扱えるようにします。
  - `getTable`や`compute`などのメソッドも、BSとPLを区別して処理できるように拡張が必要です。

- **Step 2: BS科目の期末残高計算ロジックの実装**
  - BS科目の基本計算ロジック「期末残高 = 前期末残高 + 当期の変動額」を`FAM.compute`のサイクルに組み込みます。
  - まずは単純なケースとして、PLからの利益剰余金への振り替えを実装します。
    - `compute`の各年度計算の最後に、PLで計算した`PROFIT`（当期純利益）をBSの`RETAINED_EARNINGS`（利益剰余金）に加算する処理を追加します。

- **Step 3: B&Cロジックの拡張とテスト**
  - `balanceAndChange.test.ts`を参考に、BS科目に対応するテストケースを新たに作成します。
  - `context.md`の例にある「設備投資」のケース（固定資産↑、現金↓）を題材に、B&CロジックがBS科目に正しく作用することを確認するテストを記述します。
  - このテストをパスさせる形で`applyBalanceChangeForFY`メソッドを改修し、複数のBS科目にまたがる変動を正しく処理できるようにします。

- **Step 4: CF生成機能の追加**
  - BSとPLの計算が固まった後、CF生成機能に着手します。前期と当期のBSの差額を計算し、CFの各項目にマッピングするロジックを`FAM`クラスに新たに追加します。
