# リファクタリングと今後の開発に関する指導原理

## 1. チケット: `snapshotLatestActual` のリファクタリング

### 厳密なゴール

`snapshotLatestActual`メソッド内部に存在する、財務諸表タイプ'PL'へのハードコードされた依存を完全に排除する。これにより、同メソッドを特定の財務諸表に縛られない汎用的なユーティリティへと昇華させ、BSなど任意のタイプのスナップショットを取得可能にすることが、今回のリファクタリングにおける厳密なゴールである。

この変更は、既存の機能やテストを一切破壊してはならず、追加された機能もまた、テストによって完全にその動作が保証されなければならない。

## 2. リファクタリング後の全体的対応方針

### 指導原理

三表連動のコアロジックが安定し、その正当性がテストによって担保された今、開発のフェーズは次の段階へ移行する。すなわち、確立されたコード品質とテストカバレッジを維持しつつ、**モデルの表現力と分析能力を強化すること**に焦点を当てる。

### 次のステップ（高レベル戦略）

1.  **CF計算の精緻化**:
    - **内容**: 現在はまだ概念的であるCFI（投資キャッシュフロー）およびCFF（財務キャッシュフロー）について、詳細な計算ロジックを実装する。これには、資産売却、負債の新規発行・返済、増資といった活動をモデル化するための、新たなB&Cルールやドライバーの定義が必要となるだろう。
    - **優先度**: 高。CF計算は三表連動モデルの根幹であり、ここの表現力向上がモデル全体の価値を飛躍的に高めるため。

2.  **テストシナリオの拡充**:
    - **内容**: より複雑で現実世界に即したテストケースを追加する。例えば、複数のB&Cルールが相互作用するシナリオ、のれんや減損といった非定常的な会計イベント、複雑な負債返済スケジュールなどをカバーする。
    - **優先度**: 中。コアロジックの堅牢性をさらに高め、エッジケースへの耐性を確保するために不可欠。

3.  **パフォーマンス・ベンチマーキング**:
    - **内容**: 大量の勘定科目（例: 1,000以上）や長期の予測期間（例: 20年以上）における計算パフォーマンスのベースラインを確立する。その上で、ボトルネックを特定し、最適化を行う。
    - **優先度**: 中。ツールの実用性を担保する上で重要だが、まずは機能的な表現力の向上が優先される。

4.  **API/CLIインターフェイスの強化**:
    - **内容**: 今回のリファクタリングで可能になるBSスナップショットの取得など、内部的に実装された新機能を、ツールの主要なインターフェイス（APIやCLIコマンド）を通じて外部から利用可能にする。
    - **優先度**: 低。まずは内部的な能力の強化に集中し、その後で外部への公開を進めるのが効率的である。
