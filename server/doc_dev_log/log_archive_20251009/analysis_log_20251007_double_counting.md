# 分析ログ：CF計算における二重計上問題の特定

## 1. 目的

`attachCash`ロジックを新しいCF（キャッシュフロー）ベースの現金計算ロジックに置き換えたことに伴う、多数のテスト失敗の根本原因を特定する。

## 2. ユーザー提示の思考フロー

分析の基軸として、以下の思考フローを絶対的な基準とする。

1.  PLとBS（現金以外）の当期計画値を計算する。
2.  PLの非資金性項目と、BS科目の期首からの差分（デルタ）を捉え、CFを生成する。
3.  算出された「純キャッシュフロー」を「期首の現金残高」に加算し、「期末の現金残高」を確定させる。

## 3. 現状のコードフローと矛盾点の分析

現在の`FAM.compute()`メソッドの処理の流れを、上記の思考フローと突き合わせた。

- **ステップ1（BS/PL計算）:**
  - PL科目の計算（AST評価）→ `rollForwardBsAccounts`（ルールなしBS科目の繰越）→ `applyBalanceChangeForFY`（B&Cルール対象BS科目の更新）という流れは、思考フローのステップ1に合致している。
  - この段階で「現金以外」のBS/PLが確定する。

- **ステップ2（CF生成）:**
  - `calculateCashByCF`および、その内部で呼ばれる`calculateCFs`が担当。
  - `calculateCFs`は、PLの非資金性項目（減価償却費など）を正しくCFOに加算している。これは思考フローに合致している。
  - `calculateCFs`は、**すべてのBS科目**の期首からの差分（デルタ）を計算し、CFOの調整項目としている。

- **【矛盾点の発見】**
  - `applyBalanceChangeForFY`は、例えば「設備投資」というB&Cルールに基づき、`PPE`（BS科目）の残高を更新する。
  - その**後**に実行される`calculateCFs`が、`applyBalanceChangeForFY`によって**既に更新された`PPE`の差分**を、再度CF計算の対象としてしまっている。
  - これにより、例えば「設備投資」の影響が、`applyBalanceChangeForFY`の現金への影響（`cashImpactFromBC`）と、`calculateCFs`内のBSデルタ計算の両方で**二重に計上**されるというバグが発生している。

## 4. 結論と修正方針

- **根本原因:** `calculateCFs`メソッドが、**B&Cルールによって変動したBS科目**と、**PARAMETERルール等によって変動したBS科目**を区別せず、すべてのBSデルタを画一的にCFOの調整項目として扱っていること。
- **修正方針:** `calculateCFs`メソッドを修正し、BS科目のデルタを計算する際に、その科目がB&Cルールの対象(`target`)であったかどうかを判定するロジックを追加する。B&C対象科目のデルタはCFOの計算から除外し、二重計上をなくす。
