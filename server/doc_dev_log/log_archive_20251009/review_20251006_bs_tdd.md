# BS計算ロジック実装に関するレビューと今後の計画 (2025/10/06)

## 1. 現状のゴールと課題

### 全体ゴール

`@server/doc_dev_log/bs_test_specifications.md` に基づき、BS（貸借対照表）の計算ロジックをFAMエンジンに実装する。

### 直面している課題

最重要原則である **`【G-01】貸借一致の原則 (資産 = 負債 + 純資産)`** を検証するテストケースを追加したところ、テストが失敗。この失敗を解消しようとする過程で、他の既存テストが連鎖的に失敗する「手詰まり状態」に陥っている。

## 2. これまでの試行と失敗の分析 (Herding Cats)

1.  **会計原則に基づいた修正の試み:**
    - **仮説:** 既存の現金計算ロジック `attachCash`（利益を直接現金に加算する）が会計的に不正確であり、貸借不一致の原因であると判断。
    - **アクション:** `attachCash` を削除し、会計的に正しいとされる「現金プラグ」(`balanceBs`)に置き換えようとした。
    - **結果:** `attachCash` の単純なロジックに依存していた既存の多数のテスト (`fam.behavior.test.ts` 等) が失敗。新たな `balanceBs` の実装も不完全で、目的の `[G-01]` テストもパスせず、状況が悪化。

2.  **場当たり的な修正の試み:**
    - **仮説:** `compute` メソッド内の各処理 (`rollForwardBsAccounts`, `applyBalanceChangeForFY` 等) の実行順序や相互作用に問題があると考えた。
    - **アクション:** 実行順序の入れ替えや、各メソッドの内部ロジックの微修正を繰り返した。
    - **結果:** 修正のたびに異なるテストが失敗し、根本原因の特定が困難になった。ツールの使用ミスも重なり、デバッグが非効率化し、混乱を極めた。

## 3. 失敗の根本原因と反省

**「既存のコードベースとテストが通ること」** という大原則を見失っていた。

会計的な正しさを追求するあまり、既存のテストが担保していた「現在の仕様」を破壊する変更を加えようとしていたことが、すべての問題の根源であった。`attachCash` は会計原則的には不完全だが、このコードベースにおける「仕様」の一部であり、それを前提として他の機能が成り立っていた。

## 4. 今後のアクションプラン（方針転換）

いただいた最終忠告に基づき、**「既存テストのパスを最優先し、破壊的変更を避ける」** 方針に転換する。

1.  **クリーンな状態への復帰:** まず、`git restore` を実行し、作業ディレクトリを「`[G-01]`テストを追加する直前の、全テストがパスする状態」に完全に戻す。
2.  **REDフェーズの再実行:** クリーンな状態から、`[G-01]`テストのみを再度追加し、貸借不一致で失敗することを確認する。
3.  **最小限の修正:** 貸借不一致の直接的な原因である「`rollForwardBsAccounts` が `attachCash` による現金更新を上書きしている」という点にのみスコープを絞り、`rollForwardBsAccounts` が現金勘定をスキップするよう修正する。
4.  **影響範囲の確認:** 上記の最小限の修正後、**`[G-01]`以外のすべての既存テストがパスし続けること**を最優先で確認する。
5.  **現状の記録とコミット:** `[G-01]`テストは依然として失敗する可能性が高いが、それは「モデルの現時点での限界」を示すものとして許容する。既存の仕様を壊さない範囲での改善が完了した時点で、変更をコミットし、安定した状態を確保する。
6.  **次のステップの定義:** `[G-01]`テストの失敗理由（例：`attachCash`の単純化による貸借差額）を明確に記録し、これを解決するための次の開発タスク（CF計算の実装など）として計画する。

この計画に則り、着実に開発を再開する。
