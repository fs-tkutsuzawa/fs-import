# BS計算ロジック TDD実装計画書

## 1. 基本設計思想：会計原則への回帰

本計画の根底には、`principle_for_financial_statement_modeling.md`およびユーザーから提示された「人間の思考フロー」がある。すなわち、**`attachCash`という単純化された仕様から脱却し、会計原則に忠実な三表連動モデルを実現すること**を最終目的とする。

その核心は以下のフローである。

> 1.  PLとBS（現金以外）の当期計画値を計算する。
> 2.  PLの非資金性項目と、BS科目の期首からの差分（デルタ）を捉え、キャッシュフロー計算書（CF）を生成する。
> 3.  算出された「純キャッシュフロー」を「期首の現金残高」に加算し、「期末の現金残高」を確定させる。
> 4.  この操作の結果として、BSの貸借（資産 = 負債 + 純資産）は、**必然的に一致する**。

この原則に基づき、すべてのテストと実装は、この最終形態から逆算して段階的に構築される。

## 2. 現状分析と出発点

### 2.1. コードベース (`@server/src/`)

- **`fam.ts`**: `compute`メソッド内に`attachCash`が存在し、既存テストの多くがこの単純な現金計算ロジックに依存している。一方で、`rollForwardBsAccounts`や`applyBalanceChangeForFY`など、BS計算の拡張基盤となる雛形も存在する。
- **`tests/`**:
  - `fam.behavior.test.ts`等が`attachCash`に強く依存している。
  - `bs.test.ts`には、本計画の目標である貸借一致テスト`[G-01]`が既に（失敗する状態で）存在し、さらにPL-BS連携や個別計算ルールのテストも部分的に実装済みである。

### 2.2. テストスイートの現状

`git restore .`と`test.skip`の適用により、以下の安定した状態から開始する。

- `bs.test.ts`内の`[G-01]`テストは**スキップ**されている。
- 上記を除く**全ての既存テストはパス**している。

## 3. 実装フェーズ

### フェーズ1: 基盤整備とPL-BSの基本連携

**目的:** CF計算の前準備として、BSがPLの計算結果を正しく受け取れる状態にし、BS科目計算の基本的な仕組みを確立する。

---

#### **チケット 1/3: 【BSテスト】PL利益の純資産繰入**

- **前提:**
  - `bs.test.ts`が存在し、`[G-01]`以外のテストがパスする。
- **ゴール:**
  - `bs_test_specifications.md`の`Test-BS-1.1`を満たす。
  - PLで計算された当期純利益が、BSの利益剰余金に正しく加算されることを保証する。
- **戦略:**
  - `FAM.compute`の計算サイクルに、PL計算結果をBSに反映する処理を組み込む。
- **方針:**
  - この段階では貸借一致は問わない。PLからBSへの最も重要なフローを確立することに集中する。
  - `bs.test.ts`内の既存テスト`should roll forward Retained Earnings with Net Income`がこの要件を満たしているため、パスしていることを再確認し、もし未実装であれば実装する。

---

#### **チケット 2/3: 【BSテスト】BS科目の個別計算ルールの検証**

- **前提:**
  - チケット1/3が完了している。
- **ゴール:**
  - `bs_test_specifications.md`の`Test-BS-2.1`および`Test-BS-2.2`を満たす。
  - CF計算の「部品」となるBS科目の変動ロジック（`PARAMETER`型, `B&C`型）が、個別に正しく動作することを確認する。
- **戦略:**
  - `bs.test.ts`に存在する`should calculate a BS account based on a PL account parameter`や`should calculate a BS account using GROWTH_RATE`などのテストを活用・拡張する。
  - `balanceAndChange.test.ts`の知見を参考に、`B&C`型のテスト（設備投資、減価償却）を`bs.test.ts`に実装または整備する。
- **方針:**
  - ここでも貸借一致は問わない。あくまでCF計算に必要な「部品」が正しく製造されることを保証する。
  - `applyBalanceChangeForFY`などの既存ロジックを拡張・修正する。

---

### フェーズ2: CF計算の導入と貸借一致の達成

**目的:** これまで準備した部品を統合し、`attachCash`を会計原則に忠実なCF計算ロジックに置き換え、システムの最終目標である貸借一致を達成する。

---

#### **チケット 3/3: 【最重要】CF計算ロジックの導入と貸借一致原則 `[G-01]` の達成**

- **前提:**
  - チケット2/3が完了し、CF計算に必要な全ての「部品」（PL利益、BS科目の個別変動）がテスト済みである状態。
- **ゴール:**
  - `attachCash`を完全に廃止し、CF計算を通じて`[G-01]`貸借一致テストをパスさせる。
- **戦略:**
  1.  **RED:** `bs.test.ts`でスキップしている`[G-01]`テストを有効化し、失敗することを確認する。
  2.  **GREEN:** `FAM.ts`にCFベースの現金計算メソッド（例: `calculateCashByCF()`）を実装し、`[G-01]`テストをパスさせる。このメソッドは、`PL.純利益` ± `非資金性損益` ± `運転資本の増減` の計算を行う。
  3.  **REFACTOR:** `compute()`メソッド内の`attachCash()`呼び出しを、新しい`calculateCashByCF()`に置き換える。
  4.  **FIX:** `attachCash`に依存していた他のテスト（`fam.behavior.test.ts`等）が失敗するため、それらの期待値をCFベースの正しい現金残高に修正する。
- **方針:**
  - プロジェクトの核心的価値を実現する最重要タスク。
  - 最後の「FIX」のステップでは、広範囲なテスト修正が予想されるが、原因は「現金計算ロジックの変更」に限定されるため、冷静に、機械的に修正作業を行う。

## 4. 承認依頼

この計画書は、現状のコードベースと将来のアーキテクチャ構想を両立させるための、現実的かつ段階的なロードマップです。

**この計画に基づき、実装を開始してよろしいでしょうか？**
