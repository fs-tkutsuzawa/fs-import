# プロンプト：BS計算ロジックのテスト戦略策定とバグ修正

## 1. 前提情報 (Context)

あなたは財務モデリングアプリケーションのコアロジックを開発するCLI Agentです。現在、TDDアプローチに基づき、BS（貸借対照表）の計算機能の実装を進めています。

- **最終目標:** `attachCash`（利益を直接現金に加算する単純なロジック）を廃止し、会計原則に忠実な三表連動モデルを完成させること。
- **コア思想:** 以下の思考フローを厳密に遵守する必要があります。これは、このプロジェクトにおける最上位の要求事項です。
  1.  PLとBS（現金以外）の当期計画値を計算する。
  2.  PLの非資金性項目と、BS科目の期首からの差分（デルタ）を捉え、キャッシュフロー計算書（CF）を生成する。
  3.  算出された「純キャッシュフロー」を「期首の現金残高」に加算し、「期末の現金残高」を確定させる。この結果、BSの貸借は自動的に一致する。
- **現在の状況:**
  - 新しいCFベースの現金計算ロジック (`calculateCashByCF`) を導入した結果、`bs.test.ts`はパスするようになったものの、古い`attachCash`ロジックに依存していた他の多くのテスト (`fam.behavior.test.ts`, `balanceAndChange.test.ts`など) が失敗している状態です。
  - これらのテスト失敗を修正しようとする過程で、根本的なバグの存在が明らかになりました。
- **関連ドキュメント:**
  - `@server/doc_dev_log/prompt_takuk_20251007.md`: コア思想（思考フロー）が記述されています。
  - `@server/doc_dev_log/analysis_log_20251007_double_counting.md`: 現状のコードに潜む根本的なバグの分析結果です。
  - `@server/src/fam/fam.ts`: 修正対象のコアロジックです。
  - `@server/src/tests/*.test.ts`: 失敗しているテストファイル群です。

## 2. あなたへの指示 (Prompt)

上記の前提情報と関連ドキュメントをすべて精読・分析した上で、以下のタスクを**Baby Step**で実行してください。

1.  **根本原因の再確認:**
    - `analysis_log_20251007_double_counting.md`に記述されている「二重計上問題」が、現在のテスト失敗の根本原因であることを、あなた自身の言葉で再説明してください。
    - `fam.ts`の`applyBalanceChangeForFY`と`calculateCFs`の連携が、どのように思考フローの原則を破っているかを具体的に指摘してください。

2.  **修正戦略の策定:**
    - 特定した根本原因を解決するための、最小限かつ最も効果的なコード修正戦略を立案してください。
    - どのファイルの、どのメソッドを、どのように変更するべきか、具体的な方針を示してください。

3.  **テスト計画の再構築:**
    - 上記の修正戦略に基づき、失敗しているすべてのテスト (`fam.behavior.test.ts`, `balanceAndChange.test.ts`, `plOnlyAst.test.ts`) をGREEN（パス）に戻すための詳細な計画を立ててください。
    - 計画には、どのテストをどの順番で修正し、その際に期待値をどのように変更すべきか（あるいはロジックの修正だけでパスするのか）といった具体的な手順を含めてください。

4.  **実行と検証:**
    - 策定した計画に従い、コードの修正とテストの修正を一つずつ実行してください。
    - 各ステップの後に`npm test`を実行し、テスト結果が改善されることを確認しながら、最終的にすべてのテストがパスする状態を目指してください。

**最重要指示:** すべての分析と行動は、コア思想である「人間の思考フロー」から逸脱しないようにしてください。複雑な会計用語（例: 運転資本）に頼らず、あくまで「PLの非資金性項目」と「BSのデルタ」という単純な構成要素でCFが計算される、という原則を貫いてください。
