# 【会計実務家向け】テストシナリオ全解説：財務モデリングエンジンの挙動と会計原則

**日付**: 2025年10月8日
**目的**: エンジニアが実装した全テストシナリオが、会計実務上のどのような取引を想定し、財務三表（PL, BS, CF）にどう影響するかを、非エンジニア（特に会計実務家）にも理解可能な形で網羅的に解説する。

---

## はじめに

このドキュメントは、私たちの財務モデリングエンジンが「会計的に正しい」ことを保証するために実施している、全テストシナリオの「会計的な意味」を翻訳したものです。各テストは、企業の経済活動そのものであり、このドキュメントを読むことで、エンジンがどのように会計原則を理解し、実行しているかをご確認いただけます。

## Part 1: モデルの基本原則と健全性 (The Basics & Sanity Checks)

まず、エンジンが会計モデルとして成立するための、最も基本的なルールを検証します。

#### テストシナリオ [G-01]: 貸借は必ず一致するか？ (The Accounting Equation)

- **テスト対象**: `bs.test.ts`
- **会計的意味**: 会計の大原則「**資産 = 負債 + 純資産**」が、計算後も維持されるかという、最も重要なテストです。PLで利益が出て、BSの各項目が変動した後でも、最終的にBSの貸借がピタリと一致することを検証します。これが崩れると財務モデルとして成立しないため、これは「最後の砦」とも言えるテストです。

#### テストシナリオ: 間違ったモデルはエラーになるか？ (Error Handling)

- **テスト対象**: `logicErrors.test.ts`
- **会計的意味**: 「利益が売上に依存し、同時に売上が利益に依存する」といった循環参照や、存在しない勘定科目を参照するような、会計的にあり得ないモデルを組もうとした場合に、エンジンがそれを正しく「エラー」として弾けるかを確認します。これは、ユーザーが誤ったモデルを組んでしまうことを防ぐ、エンジンの自己防衛機能のテストです。

#### テストシナリオ: 勘定科目を正しく区別できるか？ (Account Identity)

- **テスト対象**: `idManagementByAccountId.test.ts`
- **会計的意味**: 例えば、同じ「売上」という括り（Global Account ID）の中に、「A事業部の売上」と「B事業部の売上」という２つの異なる勘定科目（Account ID）があったとします。このテストは、エンジンがこの2つを明確に別のものとして認識し、それぞれの数値を独立して計算・保持できることを検証します。これにより、部門別管理のような詳細なモデリングが可能になります。

## Part 2: PLとBSの連動 (Linking the P&L and BS)

利益がどのように資産に変わるのか、PLとBSが有機的に繋がるプロセスを検証します。

#### テストシナリオ: 当期純利益は、正しく利益剰余金に蓄積されるか？

- **テスト対象**: `bs.test.ts`
- **会計的意味**: 「当期純利益は、株主のものであり、配当されなければ社内に留保される」という原則の検証です。PLで計算された当期純利益が、期末にBSの純資産の部にある`利益剰余金`に正しく加算されることを確認します。これは、PLとBSを繋ぐ最も基本的な架け橋です。

#### テストシナリオ: 減価償却費は、PLとBSにどう影響するか？

- **テスト対象**: `balanceAndChange.test.ts`
- **仕訳イメージ**: `（借）減価償却費 100 / （貸）有形固定資産 100` （※簡便法。累計額勘定を使う場合も有）
- **会計的意味**: 減価償却費は、PLでは費用として利益を押し下げる一方、BSでは同額の有形固定資産を減少させます。このテストは、この二重の影響をエンジンが正しく処理できるかを確認します。さらに、後述のCF計算において、この「現金支出を伴わない費用」が正しく調整されるかも含めて検証しています。

#### テストシナリオ: BSの項目を、PLの項目から予測計算できるか？

- **テスト対象**: `bs.test.ts`
- **会計的意味**: 「買掛金の残高は、売上原価の50%程度で推移する」といった、実務でよく使う予測ロジック（パラメータ）をエンジンが実行できるかを確認します。これにより、PLの予測値からBSの値を動的に計算する、より高度なモデル構築が可能になります。

## Part 3: キャッシュフロー計算書の作成 (Building the Cash Flow Statement)

PL（発生主義）とBS（残高）の差分から、会社の血液である現金の動き（現金主義）を導き出す、三表連動の核心部分を検証します。

### 3.1 営業活動によるCF (CFO)

#### テストシナリオ: 運転資本（売掛金、在庫、買掛金など）の増減

- **テスト対象**: `cfo.test.ts`
- **会計的意味**: 「売上が増えたのに、なぜか現金が減った」という状況は、売掛金や棚卸資産が増加した際に起こります。このテストは、運転資本の増減がCFOに正しく反映されるか（例：売掛金増→CFO減、買掛金増→CFO増）を検証します。

#### テストシナリオ: 減損損失などの「非資金性費用」の調整

- **テスト対象**: `cfo.test.ts`
- **会計的意味**: 減損損失や減価償却費は、PL上では費用ですが、実際に現金が出ていくわけではありません。CFOの計算では、これらの費用を税引前利益に「足し戻す」必要があります。このテストは、その重要な調整が正しく行われることを保証します。

### 3.2 投資活動によるCF (CFI)

#### テストシナリオ: 設備投資（固定資産の購入）

- **テスト対象**: `balanceAndChange.test.ts`
- **仕訳イメージ**: `（借）有形固定資産 500 / （貸）現金 500`
- **会計的意味**: 工場や機械などを購入する設備投資は、典型的な投資活動です。このテストは、現金の支出がCFIのマイナス項目として正しく記録されることを確認します。

#### テストシナリオ: 固定資産の売却（売却益が出た場合）

- **テスト対象**: `cfi.test.ts`
- **会計的意味**: エンジンの会計理解度を試す、最も高度なテストの一つです。帳簿価額800の資産を1,000で売却した場合、PLには利益が200計上されますが、CFIには実際に得た現金収入である1,000が計上されなければなりません。このテストは、エンジンがPL上の利益をCFOから除外し、投資の成果である現金収入の全額をCFIに計上するという、複雑な再分類を正しく実行できることを検証します。

### 3.3 財務活動によるCF (CFF)

#### テストシナリオ: 銀行からの借入と返済

- **テスト対象**: `cff.test.ts`
- **会計的意味**: 銀行からお金を借りればCFFはプラスに、返済すればマイナスになります。この一連の資金調達・返済活動が、BSとCFに正しく反映されることを確認します。

#### テストシナリオ: 増資と配当

- **テスト対象**: `cff.test.ts`
- **会計的意味**: 株主からの出資（増資）はCFFのプラス、株主への還元（配当）はCFFのマイナスとなります。これらの株主との間の資金移動が正しく処理されることを検証します。

## Part 4: 統合テスト (Putting It All Together)

最後に、これまでの活動がすべて組み合わさった、現実の会社に近い状況をシミュレートします。

#### テストシナリオ: 複雑な状況下での貸借一致

- **テスト対象**: `bs_sections.test.ts`
- **会計的意味**: 「利益が出て、在庫が増え、設備投資を行い、銀行から借金をし、さらに配当も支払った」という、企業の1年間の活動をすべて詰め込んだシナリオです。この複雑な状況下で、最終的に計算されたBSの「資産合計」と「負債・純資産合計」が完全に一致することを検証します。これがパスすることで、我々のエンジンが、個別の取引だけでなく、それらが相互作用した結果においても、会計の恒等式を維持できる、堅牢なものであることが証明されます。

## まとめ

このドキュメントで解説したテスト群は、本財務モデリングエンジンが、会計実務家の思考プロセスと会計原則に忠実に作られていることを示すものです。これらのテストは、今後エンジンがより複雑な機能を取り込んでいく上でも、その品質と信頼性を守り続けるための、生命線となります。
