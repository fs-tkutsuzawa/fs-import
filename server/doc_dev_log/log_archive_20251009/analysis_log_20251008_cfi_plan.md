# CF計算の精緻化（CFI実装）に関する初期分析と開発計画

日付: 2025年10月8日

## 1. はじめに

本ドキュメントは、CF（キャッシュフロー）計算ロジックの精緻化、特にCFI（投資キャッシュフロー）の実装に着手するにあたり、現状のコードベースを分析し、課題を特定し、具体的なTDD（テスト駆動開発）による開発計画を策定した結果を記録するものである。

## 2. 現状分析

`fam.ts`、`bc.ts`、および関連するテストファイルを横断的に調査した結果、以下の現状が明らかになった。

### 2.1. CF計算ロジックの現状

- **限定的な計算範囲**: `fam.ts`内の`calculateCFs`メソッドにおいて、`cfi`（投資CF）および`cff`（財務CF）は`0`で初期化された後、一切計算ロジックが実装されていない。
- **CFO中心の実装**: 営業CF（`cfo`）は、純利益、非資金性費用（減価償却費など）、運転資本の増減から計算されており、CF計算の基本的な構造は存在する。

### 2.2. B&C（貸借調整）ルールの限界

- **CF区分の欠如**: `bc.ts`で定義されている`CFI`型（B&Cルールの実体）には、その取引がCFO, CFI, CFFのいずれに属するかを**分類するためのプロパティが存在しない**。これがCFI計算を実装する上での最大のブロッカーとなっている。
- **場当たり的な現金調整**: `balanceAndChange.test.ts`の「設備投資」テストが示すように、設備投資（CFI活動）による現金の変動は、`cashImpactFromBC`という包括的な調整額として最終的な現金残高に直接反映されている。このアプローチでは、最終的なBSの貸借は一致するものの、CF計算書の内訳（CFO/CFI/CFF）を精緻に作成することができない。

### 2.3. 特定された主要課題

1.  **課題A（データ構造）**: B&CルールがどのCF区分に影響を与えるかを定義する仕組みがない。
2.  **課題B（計算ロジック）**: `calculateCFs`メソッドが、CFIとCFFを計算するロジックを持っていない。
3.  **課題C（インターフェース）**: 計算結果としてのCF内訳（CFO, CFI, CFF）を取得するための外部インターフェースが存在しない。

## 3. 対応方針とTDD計画

上記の課題を解決するため、以下のTDDアプローチでCFIの精緻化を進める。

1.  **データ構造の拡張 (Redから開始)**:
    - `bc.ts`の`CFI`型に`cf_category: 'CFO' | 'CFI' | 'CFF'`プロパティを追加する。
    - この変更を検証するためのテストを先行して作成し、コンパイルエラー（レッド）から開発をスタートする。

2.  **CFI計算ロジックの実装 (Greenを目指す)**:
    - `calculateCFs`メソッドを修正し、B&Cルールの`cf_category`を解釈するように変更する。
    - `cf_category`が`'CFI'`であるルールから生じる現金への影響を、`cfi`変数に集計するロジックを実装する。
    - `cashImpactFromBC`による現金調整を廃止し、すべての現金影響を`calculateCFs`内でCF区分ごとに分類・集計する形にリファクタリングする。
    - `FAM`クラスに`getCFStatement(fy)`メソッドを追加し、CF内訳を返却できるようにする。
    - 新規テストで`getCFStatement`を呼び出し、`cfi`が期待値通りであることをアサートする。このテストをパスさせ、グリーン状態を目指す。

3.  **リファクタリング**:
    - `calculateCFs`および関連するコードの可読性と保守性を向上させる。

この計画に基づき、まずは`bc.ts`の型定義の修正から着手する。
