# BS（貸借対照表）計算ロジック テスト仕様書

## 1. 目的

本仕様書は、TDD（テスト駆動開発）アプローチに基づき、財務モデルのコアロジックにおけるBS（貸借対照表）計算機能の実装をガイドするためのテスト要件を定義する。

PL（損益計算書）のテスト実装で確立されたアプローチを参考に、BS特有のストック計算、PLやCF（キャッシュフロー計算書）との連携を段階的に検証し、最終的に財務三表が整合する一貫したモデルの完成を目指す。

## 2. テストの基本原則：会計等式の恒常的な検証

BSの完全性を保証するため、すべてのBS関連テストケースは、計算処理の最後に以下の**黄金律**を必ず検証（assert）すること。

- **【G-01】 貸借一致の原則**: 各会計期間の計算完了後、`資産の合計 = 負債の合計 + 純資産の合計` が必ず成立する。

この検証は、モデルの一貫性を担保する最も重要なテストとなる。

## 3. Test Suite 1: PL-BS連携の検証

PLの計算結果が、BSの純資産に正しく反映されることを検証する。

- ### **Test-BS-1.1: 当期純利益の利益剰余金への繰入**
  - **目的**: PLで計算された当期純利益が、BSの利益剰余金を正しく増加させることを確認する。
  - **前提**:
    1.  PL計算が完了し、`当期純利益 (Profit)` が特定の値（例: 100）として確定している。
    2.  前期末BSの `利益剰余金 (Retained Earnings)` の残高が既知である（例: 500）。
  - **実行**: `FAM.compute()` を1期間分、実行する。
  - **検証**: `BS.利益剰余金 (当期末) = BS.利益剰余金 (前期末) + PL.当期純利益 (当期)` が成立することをアサートする。（例: `600 = 500 + 100`）

## 4. Test Suite 2: BS科目の変動ロジック検証

BS科目の残高が、`Parameters`型および`Balance & Change`型のルールに基づいて正しく変動することを検証する。

- ### **Test-BS-2.1: `Parameters`型ルールによるBS科目計算**
  - **目的**: PL科目と同様の`Parameters`型ルール（例: `PERCENTAGE`）がBS科目でも機能することを確認する。
  - **前提**:
    1.  PL科目 `売上原価 (COGS)` が特定の値（例: 400）で計算される。
    2.  BS科目 `買掛金 (Accounts Payable)` に `PERCENTAGE` ルールを設定（例: `売上原価` の50%）。
  - **実行**: `FAM.compute()` を実行。
  - **検証**: `BS.買掛金 (当期末) = PL.売上原価 (当期) * 0.5` が成立すること。（例: `200 = 400 * 0.5`）

- ### **Test-BS-2.2: `Balance & Change` (B&C) 型ルールによるBS科目計算**
  - **目的**: フロー科目の発生が、関連するBSストック科目の残高に正しく影響を与えることを確認する。
  - #### **Test-BS-2.2.1: 減価償却（PL連動フロー）**
    - **前提**:
      - BS科目: `有形固定資産 (PPE)` (前期末 1000), `利益剰余金 (Retained Earnings)`
      - PL科目: `減価償却費 (Depreciation)` = 100
      - B&Cルール: `target: PPE`, `sign: MINUS`, `driver: Depreciation`, `counter: Retained Earnings`
    - **実行**: `FAM.compute()` を実行。
    - **検証**: `BS.有形固定資産 (当期末) = BS.有形固定資産 (前期末) - 100` が成立すること。（`900 = 1000 - 100`）
      _(注: 利益剰余金の変動は、PL純利益の減少効果とB&Cの相手勘定としての効果が相殺される挙動を想定。これは既存の`balanceAndChange.test.ts`の実装に準拠する)_

  - #### **Test-BS-2.2.2: 設備投資（PL非連動フロー）**
    - **前提**:
      - BS科目: `有形固定資産 (PPE)` (前期末 1000), `現金 (Cash)` (前期末 500)
      - B&Cルール: `target: PPE`, `sign: PLUS`, `value: 200` (設備投資額), `counter: Cash`
    - **実行**: `FAM.compute()` を実行。
    - **検証**:
      1.  `BS.有形固定資産 (当期末) = BS.有形固定資産 (前期末) + 200` が成立すること。（`1200 = 1000 + 200`）
      2.  `BS.現金 (当期末) = BS.現金 (前期末) - 200` が成立すること。（`300 = 500 - 200`）

## 5. Test Suite 3: CF-BS連携と最終残高の確定

財務三表が最終的に連携し、整合性が取れた状態で計算が完了することを検証する。

- ### **Test-BS-3.1: BS差額からのCF生成と現金残高の確定**
  - **目的**: PLとBSの中間計算結果からCFが生成され、その結果（純キャッシュフロー）がBSの現金残高を最終確定させるプロセス全体を検証する。
  - **前提**:
    1.  PLの全科目が計算済み。
    2.  BSの現金以外の全科目が、`Parameters`型および`B&C`型ルールに基づき中間計算済み。
  - **実行**:
    1.  **CF計算（Mock）**: 前期末BSと当期末BS（中間値）の各科目の差額から、`営業CF`, `投資CF`, `財務CF` を計算するロジックを（テスト内で）実行する。
        - 例: `Δ売掛金` `Δ買掛金` 等から営業CFを、`Δ有形固定資産`から投資CFを算出。
    2.  **純CFの算出**: `当期純キャッシュフロー = 営業CF + 投資CF + 財務CF` を計算する。
    3.  **現金残高の最終確定**: `FAM`の最終調整処理を呼び出す。
  - **検証**:
    1.  `BS.現金 (当期末最終) = BS.現金 (前期末) + 当期純キャッシュフロー` が成立すること。
    2.  最終確定したBSにおいて、再度 **【G-01】貸借一致の原則** が成立することをアサートする。

## 6. 実装上の考慮事項

- 上記テストを実装するには、`FAM`クラスを拡張し、`fs_type`として`'BS'`を扱えるようにする必要がある。
- `compute`メソッドの計算サイクルを拡張し、「PL計算 → BS中間計算（現金以外） → CF計算 → BS現金最終確定」という、財務諸表間の依存関係を反映したステップを導入する必要がある。
