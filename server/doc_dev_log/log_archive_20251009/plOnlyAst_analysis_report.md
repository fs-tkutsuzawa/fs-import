# `plOnlyAst.test.ts` の分析レポート

## 1. はじめに

本レポートは、`docs/context.md` に記述されたプロジェクトの概念設計に対し、テストファイル `server/src/tests/plOnlyAst.test.ts` がどの程度の範囲を実装し、何を検証しているかを明確にすることを目的とする。

## 2. `context.md` における関連概念

`context.md` では、財務予測モデルのコア概念として以下が定義されている。

- **FAM (FY-Account Matrix) モデル**: 勘定科目と会計期間を軸とするデータ構造。
- **予測ロジック (Parameters型)**: `GROWTH_RATE`（成長率）や `CALCULATION`（他項目参照計算）など、勘定科目ごとの予測値計算ルールを定義する。
- **AST (Abstract Syntax Tree)**: `Parameters` の定義から計算の依存関係を解決するためのグラフ構造。これにより、正しい順序での計算が可能になる。
- **現金連動**: 基点利益（例: 経常利益）の増減が、期末の現金残高に反映されるロジック。

## 3. `plOnlyAst.test.ts` による実現・検証内容

このテストは、大きく分けて2つの側面から `context.md` の概念を検証している。

### 3.1. 統合された財務予測フローの検証 (FAMレベル)

テストの第一部 (`describe` ブロック全体) は、`FAM` クラスを介して、実績データ (`PREVS`) と予測ルール (`RULES`) から2期間分の予測財務諸表が正しく生成されることを検証する。

- **実現していること**:
  - **PL項目の予測**: `売上`を前期比10%成長させ、それに基づいて`営業利益`、`経常利益`を計算する、という `context.md` の `Parameters`型ロジックを実装している。
  - **現金連動**: `経常利益`を基点利益とし、その値が期初の現金残高に加算されて期末現金残高が計算される、という現金連動ロジックを実装している。
- **結果仕様 (出力成果物)**:
  - **財務諸表テーブル**: `fam.getTable()` が返す、勘定科目を行、会計年度を列とする数値テーブル。
  - **検証内容**: このテーブルの予測年度（FY+1, FY+2）における各勘定科目の値が、事前に計算された期待値 (`EXPECTS`) と完全に一致することを確認している。これにより、**PL予測と現金連動の計算結果の正しさ**が保証される。

### 3.2. AST（計算エンジン）単体の検証

テストの第二部 (`test('AST検証...')`) は、`FAM`から切り離し、ASTエンジンそのものの純粋な機能と正しさを検証する。

- **実現していること**:
  - **ASTの構築**: 実績スナップショットとルールセットから、`compileUnifiedAST` を用いて計算グラフを構築する。
  - **ASTの評価**: 構築したASTを、`evalTopo`（トポロジカルソート順評価）と `evalNodeRecursive`（再帰評価）という2つの異なるアルゴリズムで評価する。
  - **ASTの可視化**: `toDOT` を使い、ASTをGraphviz形式のDOT言語文字列に変換する。
- **結果仕様 (出力成果物)**:
  - **ASTオブジェクト**: 計算の依存関係を示す内部的なグラフデータ構造。
  - **評価結果 (数値)**: ASTの各ノード（勘定科目）の計算結果。
  - **DOT文字列**: ASTの構造を可視化するためのテキスト表現。
- **検証内容**:
  1.  **妥当性**: `validateAST` により、ASTに循環参照などの不正な構造がないことを確認。
  2.  **評価アルゴリズムの一致**: `evalTopo` と `evalNodeRecursive` の計算結果が一致することを確認。これにより、**計算ロジックの堅牢性**が保証される。
  3.  **構造の確認**: `toDOT` の出力に期待されるノードが含まれていることを確認し、意図した通りのグラフが構築されていることを間接的に検証している。

## 4. 結論

`plOnlyAst.test.ts` は、`context.md`で構想された**PL科目の予測計算**という中核的な要件について、以下の2つのレベルでその実現性を証明している。

1.  **アプリケーションレベル (`FAM`)**: ユーザーから見える形での財務諸表生成が、期待通りに動作することを保証する。
2.  **エンジンレベル (`AST`)**: その計算を支えるコアエンジンが、単体で正しく、かつ堅牢に機能することを保証する。

このテストは、`Balance & Change`型を除く、**`Parameters`型ロジックの根幹をなす部分が、設計通りに実装・機能していることを示す重要な証拠**となっている。
