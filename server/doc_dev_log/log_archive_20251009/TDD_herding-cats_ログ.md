**テスト戦略そのものを見直す**という目的を理解しました。

これまでの試行錯誤は、「貸借一致の原則を現行モデルに直接導入しようとすると、既存の仕様（テスト）と衝突する」という事実を明らかにするための、重要な知識であったと捉え直しました。

その前提に立ち、戦略見直しを行うためのサマリーとして、これまでの経緯を下記に再整理します。

---

## テスト戦略見直しのための経緯サマリー

### 1. 本来の目的

`bs_test_specifications.md` に基づき、BS（貸借対照表）の計算ロジック、特に**貸借一致の原則 (`資産 = 負債 + 純資産`)** を実装すること。

### 2. 実行したテスト戦略と直面した問題

1.  **REDフェーズ:** 貸借一致を検証するテスト `[G-01]` を追加。期待通りテストは失敗。
2.  **GREENフェーズ（試行1: 会計原則の遵守）:**
    - **仮説:** 既存の現金計算ロジック `attachCash`（利益を直接現金に加算）が会計的に不正確であり、貸借不一致の根本原因である。
    - **アクション:** `attachCash` を削除し、会計的に正しい「現金プラグ」(`balanceBs`)ロジックに置き換えようと試みた。
    - **直面した問題:** `attachCash` の単純なロジックに依存していた既存の多数のテスト（`fam.behavior.test.ts` 等）が連鎖的に失敗。**会計原則を遵守しようとした結果、既存のテストが保証していた仕様を破壊してしまいました。**

3.  **GREENフェーズ（試行2: 既存仕様の尊重）:**
    - **仮説:** `attachCash` は現行の仕様とみなし、これを維持した上で貸借のズレを修正する。貸借ズレの原因は `rollForwardBsAccounts` が `attachCash` の結果を上書きしているバグであると特定。
    - **アクション:** `rollForwardBsAccounts` が現金勘定を上書きしないように修正。
    - **直面した問題:** この修正により、既存のテストはすべてパスする状態に戻ったものの、目的の `[G-01]` テストは依然として失敗。失敗の差額は、`attachCash` が考慮しない「売掛金の増加」などの運転資本の変動に起因するものであり、**`attachCash` という単純化された仕様と、厳密な貸借一致の原則との間に、構造的な矛盾がある**ことが明確になりました。

### 3. 現状と戦略見直しのための論点

- **現在のコードベースの状態:** `attachCash` は維持され、`rollForwardBsAccounts` のバグは修正済み。**`[G-01]` 以外のすべてのテストがパスする安定した状態**です。
- **明らかになった事実:**
  - 現在の `FAM` の現金計算ロジック (`attachCash`) は、**「当期利益は、そのまま現金預金の増加に等しい」**という単純なモデルに基づいています。
  - 一方で、貸借一致の原則 `[G-01]` を厳密に適用するには、売掛金や買掛金の増減（運転資本の変動）といった、**PLの利益と現金の動きの差（キャッシュフロー）**を考慮する必要があります。
- **戦略的論点:**
  - `attachCash` という単純なモデルを維持したまま、**貸借一致の原則を「現時点では追求しない」**という判断は可能か？
  - 貸借一致を達成するために、`attachCash` を破棄し、それに依存する**多数の既存テストの期待値を修正する**という大規模なリファクタリングに踏み切るべきか？
  - あるいは、`principle_for_financial_statement_modeling.md` にあるような、**CF計算を導入**して初めて、貸借一致を根本的に解決できるのではないか？

以上の経緯が、ご指摘の通り、現行のテスト戦略が貸借一致原則の直接的な実装と相性が悪い可能性を示唆しています。このサマリーを前提として、戦略の見直しを進めましょう。
