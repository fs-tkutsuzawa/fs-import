```
System:
添付のものをよく参照してください。この文脈で、この添付ファイルに厳密に従い、以下の対応をしてください。

API化は一旦いい。我々がコマンドライン上で実行して、テンプレート注入（INSERT/UPSERT）が完結する方式にする。
コマンドラインで実行するたびに、Super Calc のルールが上書きされればよい。備忘チケットとして API 化の詳細要件を記述しておいてほしいが、まずはスピード重視・マニュアル運用OKの前提で、これを書き直してほしい。
このMarkdownをアップデートする形で構わない。不明点や迷うポイントは必ずヒアリングすること。
```

### **【実装計画書】Super Calc テンプレート注入機能**

#### **1. 本計画書の目的とゴール**

##### **1.1. 背景と課題**

本財務モデリングシステムの計算ロジックは、`calculation_rules`テーブルに一元管理されている。ここには、ユーザーがシナリオごとに変更する**変動的ルール**（例: 売上成長率）と、会計原則に基づき不変であるべき**固定的ルール**（例: `営業利益 = 売上 - 売上原価`、以下 **Super Calc**）が混在している。

この現状は、以下の2つの課題を内包している。

1.  **UXの低下:** ユーザーは新規モデルを作成する都度、基本的な会計ルールを手動で再設定する必要があり、手間がかかる。
2.  **データ整合性のリスク:** ユーザーが誤ってSuper Calcを編集・削除してしまう可能性があり、モデルの計算結果の信頼性が損なわれるリスクがある。

##### **1.2. 採用ソリューションと本計画書のゴール**

上記課題を解決するため、まずは\*\*「CLI からのテンプレート注入方式」\*\*を先行実装する。エンジニアが任意タイミングでコマンドを実行し、Super Calc を追加・上書きできれば UX/整合性の課題は即座に緩和できる。将来的な API 化は別途ロードマップ化する。

本計画書のゴールは、この CLI 方式を実装するために必要な全ての情報（仕様、要件、実装計画）を提供し、**スピード重視でテンプレート注入を完遂できる状態**を整えることである。開発担当者は、このドキュメントと既存のCode Baseをインプットとして、CLI 実装と運用手順の整備を完了させる必要がある。

---

#### **2. 実装に着手する前の現状分析 (Coding Agentへの指示)**

実装を開始する前に、Code Baseの以下の点を調査・分析し、既存システムへの理解を深めてください。

##### **2.1. システムサイド (Backend) の分析**

1.  **データベーススキーマの確認:**
    - 提供されているDDLファイル（`[最新版]_DDL_1014.sql`）を精読し、特に以下のテーブルの構造と関連性を完全に理解すること。
      - `calculation_rules`: 全てのルールの格納先。
      - `scenarios`: ルールが紐づくシナリオ。
      - `user_accounts`: ユーザーが定義する勘定科目。シナリオごとに生成される可能性がある。
      - `global_accounts`: システム全体で共通の勘定科目マスタ。`ga_code`という不変のコードを持つ点に注意。
2.  **コアロジックの確認:**
    - `server/src/fam/fam.ts`: 計算エンジンのコアロジック。`calculation_rules`がどのように解釈され、計算が実行されるかを理解する。
    - `server/src/model/`: `types.ts`や`bc.ts`など、計算ルールの型定義がされているファイル群。JSONBスキーマとの整合性を確認する。
3.  **既存サービスの確認:**
    - Code Baseの中から、「新規モデル作成」および「新規シナリオ作成」を司るサービスやAPIエンドポイントを特定する。今回の注入処理は、これらの既存サービスの処理フローに組み込むことになる。

##### **2.2. CLIサイド (開発・運用ツール) の分析**

- データベースへの接続やマイグレーションを管理する既存のCLIツールやスクリプトが存在するかを確認する。開発中に注入処理を単体でテストするためのスクリプトを作成する際に、これらの既存ツールを参考にすること。

---

#### **3. 詳細な実装計画**

##### **ステップ1: Master Template (`master_rules.json`) の定義と配置**

1.  **テンプレートファイルの作成:**
    - Super Calcのルールセットを定義するJSONファイルを作成する。
    - **配置場所:** `server/src/templates/master_rules.json`
2.  **テンプレートのスキーマ定義:**
    - テンプレート内の各ルールは、`calculation_rules`テーブルのレコードとほぼ同じ構造を持つが、**勘定科目の参照方法が異なる**点に注意が必要。シナリオに依存しない不変の識別子として\*\*`global_accounts.ga_code`\*\*を使用する。
    - **`master_rules.json` のスキーマ:**
      ```json
      [
        {
          "targetAccountCode": "GROSS_PROFIT", // global_accounts.ga_code
          "rule_type": "PARAMETER",
          "rule_definition": {
            "type": "custom_calc",
            "formula": {
              "expression": "@{SALES} - @{COGS}",
              "references": [
                { "refAccountCode": "SALES" },
                { "refAccountCode": "COGS" }
              ]
            }
          }
        }
        // ... その他のSuper Calcルール
      ]
      ```
    - **キー仕様:**
      - `targetAccountCode`: ルールの対象となる科目を`ga_code`で指定。
      - `expression`: 計算式内のプレースホルダーは`@{ga_code}`形式とする。
      - `refAccountCode`: `references`配列内でも`ga_code`で参照を指定。

##### **ステップ2: テンプレート注入 CLI の実装**

1.  **CLI スクリプト:**
    - `scripts/cli/inject-super-calc.ts`（仮称）を新規作成し、`ts-node` で実行できるようにする。
    - `package.json` に `inject:super-calc` スクリプト（`ts-node scripts/cli/inject-super-calc.ts`）を登録する。
2.  **責務:**
    - `master_rules.json` を読み込む。
    - 引数として受け取った `scenario_id`（`--scenario-id=<number>`）に紐づく `user_accounts` を取得。
    - `ga_code` → `global_accounts.id` → `user_accounts.id` を解決し、テンプレートの占位情報を実際の ID／名称に置き換える。
    - `calculation_rules` に対して UPSERT（`ON CONFLICT(scenario_id, target_user_account_id, period_id)`）を実行。`rule_definition` を JSONB として格納。
3.  **オプション:**
    - `--dry-run` で SQL を実行せずに差分を表示。
    - `--all` で全シナリオに対して注入（初期実装は単一シナリオで可）。バッチ需要が出たら拡張。
4.  **トランザクション管理:**
    - CLI 実行は単一トランザクション内で完了させ、失敗時はロールバック。
    - ログ出力：挿入件数・更新件数・スキップ件数、警告（該当する `user_accounts` が無い場合など）。

##### **ステップ3: 運用フロー・ドキュメント整備**

1.  `README.md` または `docs/` に CLI の利用手順・注意点を追記する。

- 例: `npm run inject:super-calc -- --scenario-id 123`
- 実行前チェック：対象シナリオ／環境／接続先 DB の確認。

2.  シナリオ作成直後に CLI を実行する運用ルールを定義（担当者・タイミング）。
3.  将来的な自動化を見据え、注入ロジック（`master_rules.json` 読み込み〜UPSERT）をモジュール化しておき、API やバッチから再利用可能な形にする。
4.  **備忘チケット:** API 化に向けた要件（エンドポイント設計、リトライ、権限チェック等）を別途まとめる。

##### **ステップ4: 将来の自動化への布石**

1.  現在は CLI 手動実行が前提だが、以下を backlog として管理する。

- API エンドポイント実装案（`POST /scenarios/{id}/inject-master-rules`）とエラー仕様。
- シナリオ作成サービスへの自動連携方法（同期呼び出し vs 非同期ジョブ）。
- CI/CD または夜間ジョブでの定期実行案。

2.  Backlog チケットには、CLI 実装で得た知見（必要な入力、想定件数、トランザクション時間など）を記録する。

---

#### **4. UI/UXへの考慮事項 (Frontendへのガイダンス)**

- 注入されたSuper Calcルールは、計算ルール一覧画面で、ユーザーが手動で作成したルールと視覚的に区別できることが望ましい。
- **推奨実装:** Super Calcに該当するルールの行に**鍵マーク (🔒) のアイコン**を表示する。これはあくまでUI上の表示であり、編集・削除をシステム的にブロックするものではない。

---

#### **5. テスト戦略**

1.  **単体テスト:**
    - `master_rules.json`のパース処理。
    - `ga_code`から`user_accounts.id`への変換ロジック。
    - 単一のルールテンプレートが、正しく`calculation_rules`のレコード形式に変換されること。
2.  **統合テスト（CLI）:**
    - ステージング用 DB で CLI を実行し、`calculation_rules` に期待通りのレコードが挿入/更新されること。
    - シナリオ ID が存在しない場合に CLI が適切なエラー（非ゼロ終了コード）を返すこと。
3.  **E2Eテスト:**
    - 「新規シナリオ作成」→ CLI 実行 → `calculation_rules` テーブルに Super Calc ルール群が登録されていることを確認する（必要に応じて UI 確認も実施）。

---

#### **6. ゴール（Definition of Done）**

以下の全ての項目が完了した時点で、本機能の実装は完了とみなす。

- [ ] `master_rules.json`が定義され、リポジトリ内に配置されている。
- [ ] テンプレートを読み込み、DBにレコードを登録する CLI スクリプトが実装されている。
- [ ] CLI 実行手順および注意事項が README / docs に整備されている。
- [ ] 将来の API 化に向けた要件メモ（チケット）が作成されている。
- [ ] 上記に関する単体テスト、統合テストが実装され、全てパスしている。
